{% extends 'base.html' %}

{% block title %}Data - IoT Data Server{% endblock %}

{% block head %}
{{ super() }}
<!-- Moment.js for date handling -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<style>
    .device-card {
        transition: all 0.2s ease;
        margin-bottom: 20px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #e2e8f0;
    }
    .device-card:hover {
        transform: translateY(-2px);
        border-color: #cbd5e1;
    }
    .device-title {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .device-header {
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        padding: 12px 16px;
    }
    .device-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 12px;
        margin-bottom: 15px;
    }
    .stat-item {
        text-align: center;
        padding: 10px 8px;
        border-radius: 6px;
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
    }
    .stat-label {
        font-size: 0.75rem;
        color: #64748b;
        font-weight: 500;
        margin-bottom: 4px;
    }
    .stat-value {
        font-size: 0.95rem;
        font-weight: 600;
        color: #334155;
        word-break: break-word;
        max-height: 60px;
        overflow-y: auto;
    }
    .topic-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
        margin: 0.1rem;
        display: inline-block;
        border-radius: 4px;
        background-color: #e0f2fe;
        color: #0369a1;
        border: 1px solid #bae6fd;
    }
    .client-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.6rem;
        margin-right: 0.5rem;
        background-color: #f1f5f9;
        color: #475569;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
    }
    .device-data-table {
        font-size: 0.85rem;
        max-height: 300px;
        overflow-y: auto;
        width: 100%;
        position: relative;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
        
    }
    .device-data-table .table {
        margin-bottom: 0;
        table-layout: fixed;
        width: 100%;
    }
    .device-data-table .table-responsive {
        overflow-x: auto;
        max-width: 100%;
    }
    .device-data-table .table th {
        background-color: #f8fafc;
        color: #475569;
        font-weight: 600;
        padding: 0.5rem;
        border-bottom: 1px solid #e2e8f0;
    }
    .device-data-table .table td {
        padding: 0.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
        border-bottom: 1px solid #f1f5f9;
    }
    .device-data-table pre {
        max-height: 60px;
        overflow-y: auto;
        margin-bottom: 0;
        font-size: 0.75rem;
        white-space: pre-wrap;       /* css-3 */
        white-space: -moz-pre-wrap;  /* Mozilla */
        white-space: -pre-wrap;      /* Opera 4-6 */
        white-space: -o-pre-wrap;    /* Opera 7 */
        word-wrap: break-word;       /* Internet Explorer 5.5+ */
        width: 100%;
        background-color: #f8fafc;
        padding: 4px;
        border-radius: 4px;
        border: 1px solid #e2e8f0;
    }
    .payload-cell {
        max-width: 150px;
    }
    .data-table {
        border-collapse: collapse;
    }
    .timestamp-column {
        width: 30%;
    }
    .topic-column {
        width: 25%;
    }
    .payload-column {
        width: 45%;
    }
    /* Pagination styles */
    .pagination-container {
        margin-top: 10px;
        border-top: 1px solid #f1f5f9;
        padding-top: 10px;
    }
    .device-pagination .page-link {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        color: #334155;
        border-color: #e2e8f0;
    }
    .device-pagination .page-item.active .page-link {
        background-color: #0369a1;
        border-color: #0369a1;
    }
    
    /* Real-time update indicator */
    .data-update-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #10b981;
        margin-left: 8px;
        opacity: 0;
    }
    .data-update-indicator.active {
        animation: blink 2s ease-in-out;
    }
    @keyframes blink {
        0% { opacity: 0; }
        25% { opacity: 1; }
        75% { opacity: 1; }
        100% { opacity: 0; }
    }
    
    /* Client and topic info styles */
    .device-info-section {
        margin-bottom: 15px;
        padding: 12px;
        background-color: #f8fafc;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
    }
    .device-info-title {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #334155;
    }
    .topics-container {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 5px;
    }
    .device-meta {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
    }
    .device-meta-label {
        font-size: 0.8rem;
        color: #64748b;
        margin-right: 5px;
        min-width: 60px;
    }
    .device-meta-value {
        font-size: 0.85rem;
        font-weight: 500;
        color: #334155;
    }
    
    /* Data records header */
    .data-records-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 5px;
    }
    
    /* Export button */
    .device-export {
        border-color: #e2e8f0;
        color: #0369a1;
        transition: all 0.2s;
    }
    .device-export:hover {
        background-color: #0369a1;
        border-color: #0369a1;
        color: white;
    }
    
    /* Badge styling */
    .device-title .badge {
        font-weight: 500;
        background-color: #e0f2fe;
        color: #0369a1;
        border: 1px solid #bae6fd;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
        .device-stats {
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        }
        
        .stat-item {
            padding: 8px 4px;
        }
        
        .stat-value {
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mt-3 mb-4">Telemetry Data</h2>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background-color: rgba(0,0,0,0.3); z-index: 9999; display: flex; justify-content: center; align-items: center;">
        <div class="bg-white p-4 rounded shadow-sm">
            <div class="d-flex align-items-center">
                <div class="spinner-border text-primary me-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>
                    <h5 class="mb-0" id="loadingMessage">Exporting data...</h5>
                    <small class="text-muted" id="loadingDetails">This may take a moment</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filter Form -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Filter Data</h5>
            <div class="text-end">
                <span class="badge rounded-pill bg-primary">
                    <span id="dataCount">{{ device_data|length }}</span> Devices
                </span>
                {% if selected_topic %}
                <span class="badge rounded-pill bg-success">
                    Topic: {{ topics|selectattr('id', 'equalto', selected_topic)|map(attribute='name')|first }}
                </span>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-6">
                    <label for="topic_id" class="form-label">Topic</label>
                    <select class="form-select" id="topic_id" name="topic_id">
                        <option value="">All Topics</option>
                        {% for topic in topics %}
                        <option value="{{ topic.id }}" {% if selected_topic == topic.id %}selected{% endif %}>
                            {{ topic.name }} (ID: {{ topic.id }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button type="submit" class="btn btn-primary">Apply Filter</button>
                        <a href="{{ url_for('data') }}" class="btn btn-outline-secondary">Reset</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Device Cards -->
    <div class="row" id="device-cards">
        {% if device_data %}
            {% for device_id, info in device_data.items() %}
            <div class="col-xl-6">
                <div class="card device-card" id="device-{{ device_id }}">
                    <div class="card-header device-header">
                        <div class="device-title">
                            <h5 class="mb-0">{{ info.device.name }}</h5>
                            <span class="badge bg-info">ID: {{ info.device.id }}</span>
                            <span class="data-update-indicator"></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Device Stats -->
                        <div class="device-stats mb-3">
                            <div class="stat-item">
                                <div class="stat-label">Last Seen</div>
                                <div class="stat-value last-seen-value">{{ info.device.last_seen|default('-', true) }}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Data Points</div>
                                <div class="stat-value data-points-value">{{ info.telemetry|length }}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">Last Value</div>
                                <div class="stat-value last-value-content">
                                    {% if info.telemetry|length > 0 %}
                                        {% set last_item = info.telemetry|first %}
                                        {% if last_item.payload is string %}
                                            {{ last_item.payload }}
                                        {% else %}
                                            {{ last_item.payload|tojson }}
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Device Info Section -->
                        <div class="device-info-section">
                            <div class="device-info-title">Device Information</div>
                            <div class="device-meta">
                                <div class="device-meta-label">Client:</div>
                                <div class="device-meta-value">
                                    {% for client in clients %}
                                        {% if client.id == info.device.client_id %}
                                            <span class="client-badge">{{ client.name }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="device-meta">
                                <div class="device-meta-label">Topics:</div>
                                <div class="topics-container">
                                    {% set device_topic_ids = [] %}
                                    {% for item in info.telemetry %}
                                        {% if item.topic_id not in device_topic_ids %}
                                            {% set _ = device_topic_ids.append(item.topic_id) %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% for topic in topics %}
                                        {% if topic.id in device_topic_ids %}
                                            <span class="topic-badge badge bg-primary">{{ topic.name }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Data Records Title -->
                        <div class="data-records-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Data Records</h6>
                            <div>
                            <button class="btn btn-sm btn-outline-primary device-export" data-device-id="{{ device_id }}">
                                    <i class="fas fa-download me-1"></i>Export All
                            </button>
                                {% if selected_topic %}
                                <button class="btn btn-sm btn-outline-secondary device-topic-export" data-device-id="{{ device_id }}" data-topic-id="{{ selected_topic }}">
                                    <i class="fas fa-file-export me-1"></i>Export Topic
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Data Records -->
                        <div class="device-data-table">
                            <div class="table-responsive">
                                <table class="table table-sm table-striped table-hover data-table">
                                    <thead>
                                        <tr>
                                            <th class="timestamp-column">Timestamp</th>
                                            <th class="topic-column">Topic</th>
                                            <th class="payload-column">Payload</th>
                                        </tr>
                                    </thead>
                                    <tbody class="device-data-tbody" data-device-id="{{ device_id }}">
                                        {% for item in info.telemetry %}
                                        <tr class="data-row device-{{ device_id }}-page-{{ (loop.index0 // 5) + 1 }}" {% if loop.index0 >= 5 %}style="display: none;"{% endif %}>
                                            <td>{{ item.timestamp }}</td>
                                            <td>
                                                {% for topic in topics %}
                                                    {% if topic.id == item.topic_id %}
                                                        {{ topic.name }}
                                                    {% endif %}
                                                {% endfor %}
                                            </td>
                                            <td class="payload-cell">
                                                <pre><code>{{ item.payload }}</code></pre>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Pagination Controls -->
                            {% if info.telemetry|length > 5 %}
                            <div class="d-flex justify-content-center mt-3 pagination-container">
                                <nav aria-label="Device data pagination">
                                    <ul class="pagination pagination-sm device-pagination" data-device-id="{{ device_id }}" data-total-pages="{{ (info.telemetry|length / 5)|round(0, 'ceil')|int }}">
                                        <li class="page-item disabled">
                                            <a class="page-link prev-page" href="javascript:void(0)" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                        {% for i in range(1, (info.telemetry|length / 5)|round(0, 'ceil')|int + 1) %}
                                        <li class="page-item {% if i == 1 %}active{% endif %}">
                                            <a class="page-link page-number" href="javascript:void(0)" data-page="{{ i }}">{{ i }}</a>
                                        </li>
                                        {% endfor %}
                                        <li class="page-item {% if info.telemetry|length <= 5 %}disabled{% endif %}">
                                            <a class="page-link next-page" href="javascript:void(0)" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    No telemetry data available for any device. Please check your filter settings or ensure devices are sending data.
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- Data Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Records</h5>
            <div>
                <button id="exportCsvBtn" class="btn btn-sm btn-outline-secondary me-1">
                    <i class="fas fa-file-export me-1"></i>Export All CSV
                </button>
                {% if selected_topic %}
                <button id="exportTopicCsvBtn" class="btn btn-sm btn-outline-primary me-1" data-topic-id="{{ selected_topic }}">
                    <i class="fas fa-file-export me-1"></i>Export Topic CSV
                </button>
                {% endif %}
                <form action="{{ url_for('cleanup_data_route') }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-warning" onclick="return confirm('Are you sure you want to clean up orphaned data?');">
                        <i class="fas fa-broom me-1"></i>Clean Up Orphaned Data
                    </button>
                </form>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="all-data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Timestamp</th>
                            <th>Device</th>
                            <th>Topic</th>
                            <th>Payload</th>
                        </tr>
                    </thead>
                    <tbody id="all-data-tbody">
                        {% for item in data %}
                        <tr class="all-data-row all-data-page-{{ (loop.index0 // 10) + 1 }}" {% if loop.index0 >= 10 %}style="display: none;"{% endif %}>
                            <td>{{ item.id }}</td>
                            <td>{{ item.timestamp }}</td>
                            <td>
                                {% for device in devices %}
                                    {% if device.id == item.device_id %}
                                        {{ device.name }}
                                    {% endif %}
                                {% endfor %}
                                (ID: {{ item.device_id }})
                            </td>
                            <td>
                                {% for topic in topics %}
                                    {% if topic.id == item.topic_id %}
                                        {{ topic.name }}
                                    {% endif %}
                                {% endfor %}
                                (ID: {{ item.topic_id }})
                            </td>
                            <td>
                                <pre class="mb-0"><code>{{ item.payload }}</code></pre>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center">No data available with the selected filters</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- All Data Pagination Controls -->
            {% if data|length > 10 %}
            <div class="d-flex justify-content-center mt-3 pagination-container">
                <nav aria-label="All data pagination">
                    <ul class="pagination pagination-sm" id="all-data-pagination">
                        <li class="page-item disabled">
                            <a class="page-link" href="javascript:void(0)" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% for i in range(1, (data|length / 10)|round(0, 'ceil')|int + 1) %}
                        <li class="page-item {% if i == 1 %}active{% endif %}">
                            <a class="page-link" href="javascript:void(0)" data-page="{{ i }}">{{ i }}</a>
                        </li>
                        {% endfor %}
                        <li class="page-item {% if data|length <= 10 %}disabled{% endif %}">
                            <a class="page-link" href="javascript:void(0)" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if device_data or data %}
<script>
$(document).ready(function() {
    // Ensure moment.js is available
    if (typeof moment === 'undefined') {
        console.error('Moment.js is not loaded. Loading it now...');
        // Dynamically load moment.js if not available
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js';
        script.onload = function() {
            console.log('Moment.js loaded successfully.');
            initializeApp();
        };
        document.head.appendChild(script);
    } else {
        console.log('Moment.js is already loaded.');
        initializeApp();
    }
    
    // Main application initialization
    function initializeApp() {
        // Format timestamps
        $('.timestamp').each(function() {
            const timestamp = $(this).text();
            if (timestamp) {
                const formattedTime = moment(timestamp).format('YYYY-MM-DD HH:mm:ss');
                $(this).text(formattedTime);
            }
        });
        
        // Initialize config
        const config = {
            api: {
                deviceData: '/api/device_data',
                latestData: '/api/latest_data'
            },
            updateInterval: 1000, // 1 second
            animationDuration: 2000 // 2 seconds
        };
        
        // Store current data for comparison
        let currentDeviceData = {};
        let currentAllData = [];
        
        // For pagination tracking
        const deviceDataMap = new Map();
        const devicePaginationState = {};
        let allDataPaginationState = {
            currentPage: 1,
            rowsPerPage: 10
        };
        
        // Initialize with current data
        try {
        {% if device_data %}
        currentDeviceData = {{ device_data|tojson }};
        {% endif %}
        
        {% if data %}
        currentAllData = {{ data|tojson }};
        {% endif %}
        
            // Kiểm tra và khởi tạo device data map cho pagination và export
            console.log("Khởi tạo deviceDataMap từ dữ liệu ban đầu");
            if (currentDeviceData && typeof currentDeviceData === 'object') {
        Object.entries(currentDeviceData).forEach(([deviceId, info]) => {
                    if (info && Array.isArray(info.telemetry)) {
            deviceDataMap.set(deviceId, info.telemetry);
                        console.log(`- Đã tải dữ liệu cho thiết bị ID: ${deviceId}, ${info.telemetry.length} bản ghi`);
                    } else {
                        console.warn(`- Không có dữ liệu telemetry hợp lệ cho thiết bị ID: ${deviceId}`);
                        deviceDataMap.set(deviceId, []);
                    }
                });
            } else {
                console.warn("Không có dữ liệu thiết bị ban đầu");
            }
        } catch (error) {
            console.error("Lỗi khi khởi tạo dữ liệu:", error);
        }
        
        // Function to update device cards with real-time data
        async function updateDeviceCards() {
            try {
                // Get the current topic filter if any
                const topicId = {{ selected_topic|default('null', true) }};
                
                // Fetch updated device data
                const response = await fetch(`${config.api.deviceData}?${topicId ? 'topic_id=' + topicId : ''}`);
                if (!response.ok) throw new Error('Failed to fetch device data');
                
                const result = await response.json();
                const newDeviceData = result.device_data;
                
                // Update each device card if there's new data
                for (const [deviceId, info] of Object.entries(newDeviceData)) {
                    const deviceCard = $(`#device-${deviceId}`);
                    
                    // Check if this is new data
                    let hasNewData = false;
                    
                    // If we have this device already
                    if (currentDeviceData[deviceId]) {
                        // Compare telemetry data
                        if (info.telemetry.length > 0 && 
                            (!currentDeviceData[deviceId].telemetry.length || 
                             info.telemetry[0].id !== currentDeviceData[deviceId].telemetry[0].id)) {
                            hasNewData = true;
                        }
                    } else {
                        // This is a completely new device
                        hasNewData = true;
                    }
                    
                    if (hasNewData) {
                        // Activate the update indicator
                        deviceCard.find('.data-update-indicator').addClass('active');
                        
                        // Update the device card content
                        updateDeviceCardContent(deviceId, info);
                        
                        // Remove the active class after animation completes
                        setTimeout(() => {
                            deviceCard.find('.data-update-indicator').removeClass('active');
                        }, config.animationDuration);
                    }
                }
                
                // Update current data for next comparison
                currentDeviceData = newDeviceData;
                
            } catch (error) {
                console.error('Error updating device cards:', error);
            }
        }
        
        // Function to update a specific device card's content
        function updateDeviceCardContent(deviceId, info) {
            const deviceCard = $(`#device-${deviceId}`);
            if (!deviceCard.length) {
                // If the card doesn't exist yet, we need to create it
                // This would be a full page reload case, so we'll skip for now
                return;
            }
            
            // Update last seen
            deviceCard.find('.last-seen-value').text(info.device.last_seen || '-');
            
            // Update data points count
            deviceCard.find('.data-points-value').text(info.telemetry.length);
            
            // Update last value
            if (info.telemetry.length > 0) {
                const lastItem = info.telemetry[0];
                let lastValueText = '';
                
                if (typeof lastItem.payload === 'string') {
                    lastValueText = lastItem.payload;
                } else {
                    lastValueText = JSON.stringify(lastItem.payload);
                }
                
                deviceCard.find('.last-value-content').text(lastValueText);
            }
            
            // Store the device's full telemetry data for pagination and full export
            // This ensures pagination works correctly during real-time updates
            deviceDataMap.set(deviceId, info.telemetry);
            
            // Don't update the table directly during real-time updates
            // Instead, let the pagination system handle table updates
            // This preserves the current page state and prevents disappearing records
            
            // Update pagination if initialized
            if (devicePaginationState[deviceId]) {
                // Refresh pagination while maintaining current page
                const currentPage = devicePaginationState[deviceId].currentPage;
                initDevicePagination(deviceId, currentPage);
            }
        }
        
        // Initialize device data pagination
        function initDevicePagination(deviceId, preservePage) {
            const deviceCard = $(`#device-${deviceId}`);
            if (!deviceCard.length) {
                console.warn(`Không tìm thấy card cho thiết bị ID: ${deviceId}`);
                return;
            }
            
            const tableBody = deviceCard.find('.device-data-tbody');
            const paginationContainer = deviceCard.find('.device-pagination');
            const rowsPerPage = 5;
            
            // Kiểm tra và lấy dữ liệu cho thiết bị này
            let telemetryData = [];
            
            // Nếu deviceDataMap có dữ liệu cho thiết bị này, sử dụng nó
            if (deviceDataMap && deviceDataMap.has(deviceId)) {
                telemetryData = deviceDataMap.get(deviceId) || [];
            }
            // Nếu không có dữ liệu trong deviceDataMap, thử lấy từ currentDeviceData
            else if (currentDeviceData && currentDeviceData[deviceId] && 
                     currentDeviceData[deviceId].telemetry) {
                telemetryData = currentDeviceData[deviceId].telemetry;
                // Cập nhật deviceDataMap để sử dụng sau này
                if (deviceDataMap) {
                    deviceDataMap.set(deviceId, telemetryData);
                }
            }
            
            // Đảm bảo telemetryData là một mảng hợp lệ
            if (!Array.isArray(telemetryData)) {
                console.error(`Dữ liệu telemetry cho thiết bị ID: ${deviceId} không phải là mảng`);
                telemetryData = [];
            }
            
            // Initialize or get pagination state
            if (!devicePaginationState[deviceId]) {
                devicePaginationState[deviceId] = {
                    currentPage: 1,
                    rowsPerPage: rowsPerPage
                };
            }
            
            // Use preserved page if specified, otherwise keep current page
            const currentPage = preservePage || devicePaginationState[deviceId].currentPage;
            devicePaginationState[deviceId].currentPage = currentPage;
            
            // Calculate pagination
            const totalPages = Math.max(1, Math.ceil(telemetryData.length / rowsPerPage));
            
            // Đảm bảo trang hiện tại không vượt quá tổng số trang
            const validatedCurrentPage = Math.min(currentPage, totalPages);
            if (validatedCurrentPage !== currentPage) {
                devicePaginationState[deviceId].currentPage = validatedCurrentPage;
            }
            
            const startIndex = (validatedCurrentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, telemetryData.length);
            const displayData = telemetryData.slice(startIndex, endIndex);
            
            // Update table with current page data
            tableBody.empty();
            
            if (displayData.length === 0) {
                tableBody.append('<tr><td colspan="3" class="text-center">Không có dữ liệu để hiển thị</td></tr>');
            } else {
            displayData.forEach(item => {
                    try {
                const timestamp = moment(item.timestamp).format('YYYY-MM-DD HH:mm:ss');
                const topicName = item.topic_name || 'Unknown';
                
                let payloadText = '';
                if (typeof item.payload === 'string') {
                    try {
                        const payloadObj = JSON.parse(item.payload);
                        payloadText = JSON.stringify(payloadObj, null, 2);
                    } catch {
                        payloadText = item.payload;
                    }
                        } else if (item.payload === null || item.payload === undefined) {
                            payloadText = '';
                } else {
                    payloadText = JSON.stringify(item.payload, null, 2);
                }
                
                const row = `
                <tr>
                    <td class="timestamp-column">${timestamp}</td>
                    <td class="topic-column">${topicName}</td>
                    <td class="payload-column payload-cell">
                        <pre>${payloadText}</pre>
                    </td>
                </tr>`;
                
                tableBody.append(row);
                    } catch (error) {
                        console.error("Lỗi khi hiển thị dữ liệu:", error, item);
                        const row = `
                        <tr>
                            <td class="timestamp-column">${item.timestamp ? moment(item.timestamp).format('YYYY-MM-DD HH:mm:ss') : 'N/A'}</td>
                            <td class="topic-column">${item.topic_name || 'Unknown'}</td>
                            <td class="payload-column payload-cell">
                                <pre>Lỗi hiển thị dữ liệu</pre>
                            </td>
                        </tr>`;
                        tableBody.append(row);
                    }
                });
            }
            
            // Update pagination UI
            paginationContainer.empty();
            if (totalPages <= 1) {
                return; // No pagination needed
            }
            
            // Create pagination controls
            let paginationHtml = `
            <ul class="pagination pagination-sm justify-content-center">
                <li class="page-item ${validatedCurrentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" data-page="${validatedCurrentPage - 1}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>`;
                
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `
                <li class="page-item ${i === validatedCurrentPage ? 'active' : ''}">
                    <a class="page-link" href="javascript:void(0)" data-page="${i}">${i}</a>
                </li>`;
            }
            
            paginationHtml += `
                <li class="page-item ${validatedCurrentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" data-page="${validatedCurrentPage + 1}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>`;
            
            paginationContainer.html(paginationHtml);
            
            // Add event listeners
            paginationContainer.find('.page-link').on('click', function(e) {
                e.preventDefault();
                const page = parseInt($(this).data('page'));
                
                // Chỉ xử lý khi page là số hợp lệ
                if (!isNaN(page) && page > 0 && page <= totalPages) {
                // Update state
                devicePaginationState[deviceId].currentPage = page;
                    // Redraw table
                    initDevicePagination(deviceId, page);
                }
            });
        }
        
        // Function to update the all data table
        async function updateAllDataTable() {
            try {
                // Get the current topic filter if any
                const topicId = {{ selected_topic|default('null', true) }};
                
                // Fetch latest data
                const response = await fetch(`${config.api.latestData}?limit=100${topicId ? '&topic_id=' + topicId : ''}`);
                if (!response.ok) throw new Error('Failed to fetch latest data');
                
                const result = await response.json();
                const newData = result.latest_data;
                
                // Check if there's new data
                let hasNewData = false;
                
                if (newData.length > 0 && 
                    (!currentAllData.length || 
                     newData[0].id !== currentAllData[0].id)) {
                    hasNewData = true;
                }
                
                if (hasNewData) {
                    // Activate the update indicator
                    $('.all-data-indicator').addClass('active');
                    
                    // Store the new data
                    currentAllData = newData;
                    
                    // Update the table content while preserving pagination
                    updateAllDataTableWithPagination();
                    
                    // Remove the active class after animation completes
                    setTimeout(() => {
                        $('.all-data-indicator').removeClass('active');
                    }, config.animationDuration);
                }
                
            } catch (error) {
                console.error('Error updating all data table:', error);
            }
        }
        
        // Function to update the all data table content with pagination
        function updateAllDataTableWithPagination() {
            // Calculate pagination
            const totalPages = Math.ceil(currentAllData.length / allDataPaginationState.rowsPerPage);
            const startIndex = (allDataPaginationState.currentPage - 1) * allDataPaginationState.rowsPerPage;
            const endIndex = startIndex + allDataPaginationState.rowsPerPage;
            const displayData = currentAllData.slice(startIndex, endIndex);
            
            // Update table content
            updateAllDataTableContent(displayData);
            
            // Update pagination UI
            updateAllDataPaginationUI(totalPages);
        }
        
        // Function to update the all data table content
        function updateAllDataTableContent(data) {
            const tableBody = $('#all-data-tbody');
            if (!tableBody.length) return;
            
            // Clear existing rows
            tableBody.empty();
            
            // Add new rows
            data.forEach(item => {
                const timestamp = moment(item.timestamp).format('YYYY-MM-DD HH:mm:ss');
                
                let payloadText = '';
                if (typeof item.payload === 'string') {
                    try {
                        const payloadObj = JSON.parse(item.payload);
                        payloadText = JSON.stringify(payloadObj, null, 2);
                    } catch {
                        payloadText = item.payload;
                    }
                } else {
                    payloadText = JSON.stringify(item.payload, null, 2);
                }
                
                const row = `
                <tr>
                    <td>${item.id}</td>
                    <td>${timestamp}</td>
                    <td>${item.device_name || 'Unknown'} (ID: ${item.device_id || 'N/A'})</td>
                    <td>${item.topic_name || 'Unknown'} (ID: ${item.topic_id || 'N/A'})</td>
                    <td class="payload-cell">
                        <pre>${payloadText}</pre>
                    </td>
                </tr>`;
                
                tableBody.append(row);
            });
        }
        
        // Function to update pagination UI for all data table
        function updateAllDataPaginationUI(totalPages) {
            const paginationContainer = $('#all-data-pagination');
            if (!paginationContainer.length) return;
            
            paginationContainer.empty();
            
            if (totalPages <= 1) {
                return; // No pagination needed
            }
            
            // Create pagination controls
            let paginationHtml = `
            <ul class="pagination pagination-sm justify-content-center">
                <li class="page-item ${allDataPaginationState.currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" data-page="${allDataPaginationState.currentPage - 1}" aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>`;
                
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `
                <li class="page-item ${i === allDataPaginationState.currentPage ? 'active' : ''}">
                    <a class="page-link" href="javascript:void(0)" data-page="${i}">${i}</a>
                </li>`;
            }
            
            paginationHtml += `
                <li class="page-item ${allDataPaginationState.currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" data-page="${allDataPaginationState.currentPage + 1}" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>`;
            
            paginationContainer.html(paginationHtml);
        }
        
        // Initialize all data pagination
        function initAllDataPagination() {
            $('#all-data-pagination').on('click', 'a.page-link', function(e) {
                e.preventDefault();  // Prevent page jump
                const page = parseInt($(this).data('page'));
                
                // Validate page number
                const totalPages = Math.ceil(currentAllData.length / allDataPaginationState.rowsPerPage);
                if (page < 1 || page > totalPages) return;
                
                // Update state
                allDataPaginationState.currentPage = page;
                
                // Update display
                updateAllDataTableWithPagination();
            });
            
            // Initial pagination setup
            updateAllDataTableWithPagination();
        }
        
        // CSV Export functionality
        function setupCsvExport() {
            // Sửa selector để nhắm đúng ID của nút export chung
            $('#exportCsvBtn').on('click', function() {
                const targetTable = '#all-data-table'; // Nhắm vào bảng "All Records"
                const filename = 'all_records_export.csv'; // Đặt tên file mặc định

                // Kiểm tra xem bảng có tồn tại không
                if ($(targetTable).length === 0) {
                    alert('Lỗi: Không tìm thấy bảng dữ liệu "All Records".');
                    return;
                }

                const rows = [];
                const headers = [];
                
                // Lấy headers từ thead của bảng
                $(`${targetTable} thead th`).each(function() {
                    headers.push($(this).text().trim());
                });
                rows.push(headers);
                
                // Lấy dữ liệu từ các hàng trong tbody của bảng
                let dataFound = false;
                $(`${targetTable} tbody tr`).each(function() {
                    // Chỉ lấy các hàng đang hiển thị (không bị display: none do phân trang)
                    if ($(this).is(":visible")) {
                    const row = [];
                    $(this).find('td').each(function() {
                            let cellText = '';
                            // Đặc biệt xử lý cho cột payload có thể chứa thẻ <pre><code>
                            if ($(this).find('pre code').length > 0) {
                                cellText = $(this).find('pre code').text().trim();
                        } else {
                                cellText = $(this).text().trim();
                        }
                            row.push(cellText);
                    });
                    rows.push(row);
                        dataFound = true;
                    }
                });

                if (!dataFound) {
                    hideLoading();
                    showError('Không có dữ liệu hiển thị để xuất cho thiết bị này.');
                    return;
                }
                
                // Convert to CSV
                let csvContent = "data:text/csv;charset=utf-8,";
                rows.forEach(function(rowArray) {
                    const row = rowArray.map(function(cell) {
                        let processedCell = cell.toString().replace(/"/g, '""');
                        if (processedCell.includes(',') || processedCell.includes('"') || processedCell.includes('\n')) {
                            processedCell = '"' + processedCell + '"';
                        }
                        return processedCell;
                    }).join(",");
                    csvContent += row + "\r\n";
                });

                // Create download link
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                hideLoading();
                showSuccess(`CSV đã được xuất thành công: ${filename}`);
            });

            // Thiết lập listener cho nút xuất CSV cho topic cụ thể
            $('#exportTopicCsvBtn').on('click', async function() {
                const topicId = $(this).data('topic-id');
                const topicName = getTopicNameById(topicId);
                const filename = `topic_${topicName ? topicName.replace(/\s+/g, '_') : topicId}_export.csv`;
                
                try {
                    // Hiển thị thông báo đang tải dữ liệu
                    const loadingMessage = $('<div class="alert alert-info position-fixed top-50 start-50 translate-middle p-3">Đang tải dữ liệu...</div>');
                    $('body').append(loadingMessage);
                    
                    // Tải tất cả dữ liệu cho topic này
                    const data = await fetchTopicData(topicId);
                    
                    // Xuất CSV khi có dữ liệu
                    exportTopicData(data, filename, topicId);
                    
                    // Xóa thông báo tải
                    loadingMessage.remove();
                } catch (error) {
                    console.error('Lỗi khi xuất dữ liệu topic:', error);
                    alert('Có lỗi xảy ra khi xuất dữ liệu. Vui lòng thử lại.');
                    $('body').find('.alert-info').remove();
                }
            });
        }

        // Hàm lấy tên topic từ ID
        function getTopicNameById(topicId) {
            let topicName = 'unknown';
            {% for topic in topics %}
            if ({{ topic.id }} === parseInt(topicId)) {
                topicName = '{{ topic.name }}';
            }
            {% endfor %}
            return topicName;
        }

        // Hàm tải tất cả dữ liệu cho một topic cụ thể
        async function fetchTopicData(topicId) {
            if (!topicId) {
                throw new Error('Topic ID không hợp lệ');
            }
            
            console.log(`Đang tải dữ liệu cho topic ID: ${topicId}`);
            
            try {
                // Tải dữ liệu thiết bị (bao gồm cả thiết bị hiện tại không hiển thị)
                const responseDevices = await fetch(`/api/device_data?topic_id=${topicId}&limit=1000`);
                if (!responseDevices.ok) throw new Error('Không thể tải dữ liệu thiết bị');
                const devicesData = await responseDevices.json();
                
                // Tải tất cả dữ liệu
                const responseAll = await fetch(`/api/latest_data?topic_id=${topicId}&limit=1000`);
                if (!responseAll.ok) throw new Error('Không thể tải dữ liệu chung');
                const allData = await responseAll.json();
                
                // Kết hợp dữ liệu
                return {
                    deviceData: devicesData.device_data || {},
                    allData: allData.latest_data || []
                };
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
                throw error;
            }
        }

        // Hàm xuất dữ liệu theo topic thành CSV
        function exportTopicData(data, filename, topicId) {
            // Kiểm tra dữ liệu
            if (!data || (!Object.keys(data.deviceData).length && !data.allData.length)) {
                alert(`Không tìm thấy dữ liệu cho topic ID: ${topicId}`);
                return;
            }
            
            // Tạo mảng dữ liệu CSV
            const rows = [];
            const headers = ['ID', 'Timestamp', 'Device', 'Topic', 'Payload'];
            rows.push(headers);
            
            // Thêm dữ liệu từ allData
            const processedIds = new Set(); // Theo dõi các ID đã xử lý
            
            data.allData.forEach(item => {
                if (item.topic_id != topicId) return; // Chỉ lấy dữ liệu cho topic được chọn
                
                processedIds.add(item.id);
                
                const row = [];
                row.push(item.id);
                row.push(moment(item.timestamp).format('YYYY-MM-DD HH:mm:ss'));
                row.push(`${item.device_name || 'Unknown'} (ID: ${item.device_id})`);
                row.push(`${item.topic_name || 'Unknown'} (ID: ${item.topic_id})`);
                
                let payloadText = '';
                if (typeof item.payload === 'string') {
                    try {
                        const payloadObj = JSON.parse(item.payload);
                        payloadText = JSON.stringify(payloadObj);
                    } catch (e) {
                        payloadText = item.payload;
                    }
                } else if (item.payload !== null && item.payload !== undefined) {
                    payloadText = JSON.stringify(item.payload);
                }
                
                row.push(payloadText);
                rows.push(row);
            });
            
            // Thêm dữ liệu từ deviceData nếu có mục nào chưa được xử lý
            Object.values(data.deviceData).forEach(device => {
                if (device.telemetry && Array.isArray(device.telemetry)) {
                    device.telemetry.forEach(item => {
                        if (item.topic_id != topicId) return; // Chỉ lấy dữ liệu cho topic được chọn
                        if (processedIds.has(item.id)) return; // Bỏ qua nếu đã xử lý
                        
                        const row = [];
                        row.push(item.id);
                        row.push(moment(item.timestamp).format('YYYY-MM-DD HH:mm:ss'));
                        row.push(`${device.device.name || 'Unknown'} (ID: ${device.device.id})`);
                        row.push(`${item.topic_name || 'Unknown'} (ID: ${item.topic_id})`);
                        
                        let payloadText = '';
                        if (typeof item.payload === 'string') {
                            try {
                                const payloadObj = JSON.parse(item.payload);
                                payloadText = JSON.stringify(payloadObj);
                            } catch (e) {
                                payloadText = item.payload;
                            }
                        } else if (item.payload !== null && item.payload !== undefined) {
                            payloadText = JSON.stringify(item.payload);
                        }
                        
                        row.push(payloadText);
                        rows.push(row);
                    });
                }
            });
            
            if (rows.length <= 1) {
                alert(`Không có dữ liệu CSV để xuất cho topic ID: ${topicId}`);
                return;
            }
            
            // Sắp xếp theo ID (giảm dần) để có dữ liệu mới nhất trước
            rows.slice(1).sort((a, b) => b[0] - a[0]);
            
            // Tạo nội dung CSV
            let csvContent = "data:text/csv;charset=utf-8,";
                rows.forEach(function(rowArray) {
                    const row = rowArray.map(function(cell) {
                    let processedCell = (cell === null || cell === undefined) ? '' : cell.toString();
                    processedCell = processedCell.replace(/"/g, '""');
                    if (processedCell.includes(',') || processedCell.includes('"') || processedCell.includes('\n')) {
                        processedCell = '"' + processedCell + '"';
                    }
                    return processedCell;
                }).join(",");
                csvContent += row + "\r\n";
            });
            
            // Tạo và kích hoạt liên kết tải xuống
            try {
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log(`Đã xuất ${rows.length - 1} bản ghi cho topic ID: ${topicId}`);
            } catch (error) {
                console.error("Lỗi khi tạo tệp CSV:", error);
                alert("Có lỗi xảy ra khi tạo tệp CSV. Vui lòng thử lại sau.");
            }
        }
        
        // Helper functions for loading overlay
        function showLoading(message, details) {
            $('#loadingMessage').text(message || 'Processing...');
            $('#loadingDetails').text(details || 'Please wait');
            $('#loadingOverlay').removeClass('d-none');
        }
        
        function hideLoading() {
            $('#loadingOverlay').addClass('d-none');
        }
        
        // Error handling helper
        function showError(message, duration = 5000) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3" style="z-index:9999" role="alert">
                    <strong>Error!</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            const alert = $(alertHtml);
            $('body').append(alert);
            
            setTimeout(() => {
                alert.alert('close');
            }, duration);
        }
        
        // Success message helper
        function showSuccess(message, duration = 3000) {
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3" style="z-index:9999" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            const alert = $(alertHtml);
            $('body').append(alert);
            
            setTimeout(() => {
                alert.alert('close');
            }, duration);
        }
        
        // Enhanced function to fetch data with error handling and retry
        async function fetchWithRetry(url, options = {}, retries = 2, retryDelay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Fetch failed, retrying... (${retries} attempts left)`);
                    await new Promise(resolve => setTimeout(resolve, retryDelay));
                    return fetchWithRetry(url, options, retries - 1, retryDelay * 1.5);
                }
                throw error;
            }
        }

        // Hàm helper chung để tạo và tải CSV từ dữ liệu bảng
        function exportTableDataToCsv(tableSelector, filename) {
            try {
                if ($(tableSelector).length === 0) {
                    showError(`Không tìm thấy bảng dữ liệu với selector "${tableSelector}".`);
                    return;
                }

                showLoading('Đang tạo CSV...', 'Đang xử lý dữ liệu từ bảng');
                
                const rows = [];
                const headers = [];

                // Lấy headers
                $(`${tableSelector} thead th`).each(function() {
                    headers.push($(this).text().trim());
                });
                rows.push(headers);

                // Lấy dữ liệu từ các hàng trong tbody của bảng được chỉ định
                let dataFound = false;
                $(`${tableSelector} tbody tr`).each(function() {
                    if ($(this).is(":visible")) { // Chỉ các hàng đang hiển thị
                        const row = [];
                        $(this).find('td').each(function() {
                            let cellText = '';
                            if ($(this).find('pre code').length > 0) {
                                cellText = $(this).find('pre code').text().trim();
                            } else {
                                cellText = $(this).text().trim();
                            }
                            row.push(cellText);
                        });
                        rows.push(row);
                        dataFound = true;
                    }
                });

                if (!dataFound) {
                    hideLoading();
                    showError('Không có dữ liệu hiển thị để xuất cho thiết bị này.');
                    return;
                }

                // Convert to CSV
                let csvContent = "data:text/csv;charset=utf-8,";
                rows.forEach(function(rowArray) {
                    const row = rowArray.map(function(cell) {
                        let processedCell = cell.toString().replace(/"/g, '""');
                        if (processedCell.includes(',') || processedCell.includes('"') || processedCell.includes('\n')) {
                            processedCell = '"' + processedCell + '"';
                        }
                        return processedCell;
                    }).join(",");
                    csvContent += row + "\r\n";
                });
                
                // Create download link
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                hideLoading();
                showSuccess(`CSV đã được xuất thành công: ${filename}`);
            } catch (error) {
                console.error("Lỗi khi xuất CSV:", error);
                hideLoading();
                showError("Lỗi khi xuất CSV: " + error.message);
            }
        }

        // Export all device data from the deviceDataMap
        function exportAllDeviceDataFromMap(deviceId, filename) {
            try {
                showLoading('Đang xuất dữ liệu thiết bị...', `Đang xử lý dữ liệu cho thiết bị ID: ${deviceId}`);
                
                // Kiểm tra deviceDataMap đã được khởi tạo chưa
                if (typeof deviceDataMap === 'undefined') {
                    console.error("deviceDataMap chưa được khởi tạo");
                    hideLoading();
                    showError("Không thể truy cập dữ liệu thiết bị. Vui lòng làm mới trang và thử lại.");
                    return;
                }

                // Kiểm tra xem có dữ liệu cho thiết bị này không
                if (!deviceDataMap.has(deviceId)) {
                    console.error(`deviceDataMap không có dữ liệu cho thiết bị ID: ${deviceId}`);
                    hideLoading();
                    showError(`Không tìm thấy dữ liệu đầy đủ cho thiết bị ID: ${deviceId}. Hãy chờ dữ liệu được tải hoặc làm mới trang.`);
                    return;
                }

                const telemetryData = deviceDataMap.get(deviceId); // Đây là mảng các object telemetry
                
                // Kiểm tra dữ liệu telemetry có hợp lệ và có phần tử nào không
                if (!telemetryData || !Array.isArray(telemetryData) || telemetryData.length === 0) {
                    console.error(`Không có dữ liệu telemetry hợp lệ cho thiết bị ID: ${deviceId}`);
                    hideLoading();
                    showError('Không có dữ liệu telemetry để xuất cho thiết bị này.');
                    return;
                }

                // Từ đây là thực hiện xuất dữ liệu CSV như bình thường
                const rows = [];
                // Xác định headers
                const headers = ['Timestamp', 'Topic Name', 'Payload Value', 'Payload Unit']; 
                rows.push(headers);

                // Phân tích dữ liệu có cấu trúc tốt hơn
                telemetryData.forEach(item => {
                    try {
                        const row = [];
                        row.push(moment(item.timestamp).format('YYYY-MM-DD HH:mm:ss'));
                        row.push(item.topic_name || item.topic_id); // Sử dụng topic_name nếu có

                        // Xử lý payload dựa trên loại dữ liệu
                        let payloadValue = '';
                        let payloadUnit = '';

                        if (typeof item.payload === 'string') {
                            try {
                                // Thử phân tích payload dạng chuỗi JSON
                                const payloadObj = JSON.parse(item.payload);
                                if (payloadObj && typeof payloadObj === 'object') {
                                    if (payloadObj.value !== undefined) {
                                        payloadValue = payloadObj.value;
                                        payloadUnit = payloadObj.unit || '';
                                    } else {
                                        // Trường hợp đối tượng không có thuộc tính value
                                        payloadValue = JSON.stringify(payloadObj);
                                    }
                                } else {
                                    payloadValue = item.payload;
                                }
                            } catch (e) {
                                // Nếu không phải JSON, sử dụng giá trị chuỗi gốc
                                payloadValue = item.payload;
                            }
                        } else if (item.payload && typeof item.payload === 'object') {
                            // Lấy 'value' và 'unit' nếu có
                            payloadValue = item.payload.value !== undefined ? item.payload.value : JSON.stringify(item.payload);
                            payloadUnit = item.payload.unit !== undefined ? item.payload.unit : '';
                        } else {
                            // Trường hợp payload là kiểu dữ liệu khác
                            payloadValue = item.payload !== null && item.payload !== undefined ? String(item.payload) : '';
                        }

                        row.push(payloadValue);
                        row.push(payloadUnit);
                        rows.push(row);
                    } catch (error) {
                        console.error('Lỗi khi xử lý dữ liệu telemetry:', error, item);
                        const row = [
                            item.timestamp ? moment(item.timestamp).format('YYYY-MM-DD HH:mm:ss') : 'N/A',
                            item.topic_name || item.topic_id || 'N/A',
                            'Lỗi xử lý dữ liệu',
                            ''
                        ];
                        rows.push(row);
                    }
                });

                if (rows.length <= 1) { // Chỉ có header, không có dữ liệu
                    hideLoading();
                    showError('Không có dữ liệu để xuất.');
                    return;
                }

                // Tạo nội dung CSV
                let csvContent = "data:text/csv;charset=utf-8,";
                rows.forEach(function(rowArray) {
                    const row = rowArray.map(function(cell) {
                        let processedCell = (cell === null || cell === undefined) ? '' : cell.toString();
                        processedCell = processedCell.replace(/"/g, '""');
                        if (processedCell.includes(',') || processedCell.includes('"') || processedCell.includes('\n')) {
                            processedCell = '"' + processedCell + '"';
                        }
                        return processedCell;
                    }).join(",");
                    csvContent += row + "\r\n";
                });
                
                // Tạo và kích hoạt liên kết tải xuống
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                hideLoading();
                showSuccess(`Đã xuất ${rows.length - 1} bản ghi cho thiết bị thành công.`);
            } catch (error) {
                console.error("Lỗi khi tạo tệp CSV:", error);
                hideLoading();
                showError("Có lỗi xảy ra khi tạo tệp CSV. Vui lòng thử lại sau.");
            }
        }
        
        // Hàm thiết lập export cho từng thiết bị
        function setupPerDeviceCsvExport() {
            // Sử dụng event delegation cho các nút .device-export được thêm động
            $('#device-cards').on('click', '.device-export', function() {
                const deviceId = $(this).data('device-id');
                const deviceName = $(this).closest('.device-card').find('.device-title h5').text().trim() || deviceId;
                
                // Kiểm tra nếu thiết bị có dữ liệu trong deviceDataMap
                if (typeof deviceDataMap === 'undefined' || !deviceDataMap.has(deviceId)) {
                    // Nếu deviceDataMap chưa được khởi tạo, thử tìm từ currentDeviceData
                    if (currentDeviceData && currentDeviceData[deviceId] && currentDeviceData[deviceId].telemetry) {
                        // Cập nhật deviceDataMap nếu chưa được khởi tạo nhưng có dữ liệu trong currentDeviceData
                        deviceDataMap.set(deviceId, currentDeviceData[deviceId].telemetry);
                    } else {
                        // Hiển thị thông báo lỗi với hướng dẫn để người dùng biết cách khắc phục
                        showError(`Không tìm thấy dữ liệu đầy đủ cho thiết bị ID: ${deviceId}. Hãy chờ dữ liệu được tải hoặc làm mới trang.`);
                        return;
                    }
                }
                
                // Target bảng dữ liệu cụ thể của thiết bị này
                const targetTable = `#device-${deviceId} .data-table`;
                const filename = `device_${deviceName.replace(/\s+/g, '_')}_data.csv`;

                // Gọi hàm xuất toàn bộ dữ liệu từ deviceDataMap thay vì chỉ dữ liệu đang hiển thị
                exportAllDeviceDataFromMap(deviceId, filename);
            });
        }
        
        // Hàm thiết lập export theo topic cho từng thiết bị
        function setupDeviceTopicCsvExport() {
            // Sử dụng event delegation cho các nút .device-topic-export được thêm động
            $('#device-cards').on('click', '.device-topic-export', async function() {
                const deviceId = $(this).data('device-id');
                const topicId = $(this).data('topic-id');
                const deviceName = $(this).closest('.device-card').find('.device-title h5').text().trim() || deviceId;
                const topicName = getTopicNameById(topicId);
                
                showLoading('Đang xuất dữ liệu theo topic...', `Đang xử lý dữ liệu cho thiết bị ${deviceName} và topic ${topicName}`);
                
                try {
                    const filename = `device_${deviceName.replace(/\s+/g, '_')}_topic_${topicName.replace(/\s+/g, '_')}_data.csv`;
                    
                    // Kiểm tra nếu thiết bị có dữ liệu trong deviceDataMap
                    if (typeof deviceDataMap === 'undefined' || !deviceDataMap.has(deviceId)) {
                        // Thử lấy dữ liệu từ currentDeviceData
                        if (currentDeviceData && currentDeviceData[deviceId] && currentDeviceData[deviceId].telemetry) {
                            // Cập nhật deviceDataMap
                            deviceDataMap.set(deviceId, currentDeviceData[deviceId].telemetry);
                        } else {
                            hideLoading();
                            showError(`Không tìm thấy dữ liệu cho thiết bị ID: ${deviceId}`);
                            return;
                        }
                    }
                    
                    // Lấy tất cả dữ liệu telemetry của thiết bị
                    const telemetryData = deviceDataMap.get(deviceId);
                    
                    // Lọc dữ liệu theo topic
                    const filteredData = telemetryData.filter(item => item.topic_id == topicId);
                    
                    if (!filteredData.length) {
                        hideLoading();
                        showError(`Không tìm thấy dữ liệu telemetry cho topic ID: ${topicId} trên thiết bị này.`);
                        return;
                    }
                    
                    // Tạo mảng dữ liệu CSV
                    const rows = [];
                    // Xác định headers
                    const headers = ['ID', 'Timestamp', 'Topic Name', 'Payload Value', 'Payload Unit']; 
                    rows.push(headers);
                    
                    // Xử lý dữ liệu cho mỗi mục
                    filteredData.forEach(item => {
                        try {
                            const row = [];
                            row.push(item.id || '');
                            row.push(moment(item.timestamp).format('YYYY-MM-DD HH:mm:ss'));
                            row.push(item.topic_name || topicName || 'Unknown');
                            
                            // Xử lý payload dựa trên loại dữ liệu
                            let payloadValue = '';
                            let payloadUnit = '';
                            
                            if (typeof item.payload === 'string') {
                                try {
                                    // Thử phân tích payload dạng chuỗi JSON
                                    const payloadObj = JSON.parse(item.payload);
                                    if (payloadObj && typeof payloadObj === 'object') {
                                        if (payloadObj.value !== undefined) {
                                            payloadValue = payloadObj.value;
                                            payloadUnit = payloadObj.unit || '';
                                        } else {
                                            // Trường hợp đối tượng không có thuộc tính value
                                            payloadValue = JSON.stringify(payloadObj);
                                        }
                                    } else {
                                        payloadValue = item.payload;
                                    }
                                } catch (e) {
                                    // Nếu không phải JSON, sử dụng giá trị chuỗi gốc
                                    payloadValue = item.payload;
                                }
                            } else if (item.payload && typeof item.payload === 'object') {
                                // Lấy 'value' và 'unit' nếu có
                                payloadValue = item.payload.value !== undefined ? item.payload.value : JSON.stringify(item.payload);
                                payloadUnit = item.payload.unit !== undefined ? item.payload.unit : '';
                            } else {
                                // Trường hợp payload là kiểu dữ liệu khác
                                payloadValue = item.payload !== null && item.payload !== undefined ? String(item.payload) : '';
                            }
                            
                            row.push(payloadValue);
                            row.push(payloadUnit);
                            rows.push(row);
                        } catch (error) {
                            console.error('Lỗi khi xử lý dữ liệu telemetry:', error, item);
                            const row = [
                                item.id || '',
                                item.timestamp ? moment(item.timestamp).format('YYYY-MM-DD HH:mm:ss') : 'N/A',
                                topicName || 'Unknown',
                                'Lỗi xử lý dữ liệu',
                                ''
                            ];
                            rows.push(row);
                        }
                    });
                    
                    if (rows.length <= 1) { // Chỉ có header, không có dữ liệu
                        hideLoading();
                        showError('Không có dữ liệu để xuất.');
                        return;
                    }
                    
                    // Tạo nội dung CSV
                    let csvContent = "data:text/csv;charset=utf-8,";
                    rows.forEach(function(rowArray) {
                        const row = rowArray.map(function(cell) {
                            let processedCell = (cell === null || cell === undefined) ? '' : cell.toString();
                            processedCell = processedCell.replace(/"/g, '""');
                            if (processedCell.includes(',') || processedCell.includes('"') || processedCell.includes('\n')) {
                                processedCell = '"' + processedCell + '"';
                            }
                            return processedCell;
                        }).join(",");
                        csvContent += row + "\r\n";
                    });
                    
                    // Tạo và kích hoạt liên kết tải xuống
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", filename);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    hideLoading();
                    showSuccess(`Đã xuất ${rows.length - 1} bản ghi cho thiết bị ID: ${deviceId} và topic ID: ${topicId}`);
                } catch (error) {
                    console.error("Lỗi khi tạo tệp CSV:", error);
                    hideLoading();
                    showError("Có lỗi xảy ra khi tạo tệp CSV. Vui lòng thử lại sau.");
                }
            });
        }
        
        // Initialize export
        setupCsvExport();
        setupPerDeviceCsvExport();
        setupDeviceTopicCsvExport();
        
        // Start real-time updates
        setInterval(updateDeviceCards, config.updateInterval);
        setInterval(updateAllDataTable, config.updateInterval);
        
        // Initialize pagination
        // Call for each device card
        Object.keys(currentDeviceData).forEach(deviceId => {
            initDevicePagination(deviceId);
        });
        
        // Initialize all data pagination
        initAllDataPagination();
    }
});
</script>
{% endif %}
{% endblock %}